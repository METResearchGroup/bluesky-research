name: Python CI
permissions:
  contents: read

on: [push]

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    strategy:
      matrix:
        python-version: ["3.10", "3.11", "3.12"]
      fail-fast: false
    steps:
    - uses: actions/checkout@v4
    - name: Cache uv packages and lockfile
      uses: actions/cache@v4
      with:
        path: |
          ~/.cache/uv
          uv.lock
        key: ${{ runner.os }}-uv-${{ matrix.python-version }}-${{ hashFiles('pyproject.toml', 'uv.lock') }}
        restore-keys: |
          ${{ runner.os }}-uv-${{ matrix.python-version }}-
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
    - name: Install uv
      uses: astral-sh/setup-uv@v4
      with:
        version: "latest"
    - name: Resolve deps (create/refresh uv.lock)
      run: uv lock

    - name: Install dependencies (locked)
      run: uv sync --extra dev --extra ml --extra llm --extra valence --extra telemetry --extra feed_api
    - name: Add project directory to PYTHONPATH
      run: echo "PYTHONPATH=${{ github.workspace }}" >> $GITHUB_ENV
    - name: Ruff linting
      run: |
        # stop the build if there are Python syntax errors or undefined names
        uv run ruff check .
    - name: Test with pytest
      timeout-minutes: 15
      run: |
        uv run pytest --import-mode=importlib \
          lib/tests \
          lib/db/tests \
          lib/db/sql/tests \
          lib/telemetry/tests \
          ml_tooling/llm/tests \
          ml_tooling/perspective_api/tests \
          ml_tooling/ime/tests \
          ml_tooling/valence_classifier/tests \
          services/backfill/core/tests \
          services/backfill/storage/tests \
          services/ml_inference/tests \
          services/ml_inference/perspective_api/tests \
          services/ml_inference/sociopolitical/tests \
          services/ml_inference/ime/tests \
          services/ml_inference/valence_classifier/tests \
          services/repartition_service/tests \
          services/calculate_analytics/tests \
          services/calculate_analytics/study_analytics/calculate_analytics/tests \
          services/calculate_analytics/shared/processing/tests \
          services/write_cache_buffers_to_db/tests \
          services/sync/jetstream/tests \
          api/integrations_router/tests

    - name: Lint Dockerfiles with Hadolint
      uses: hadolint/hadolint-action@v3.1.0
      with:
        dockerfile: Dockerfiles/*.Dockerfile
        recursive: true
